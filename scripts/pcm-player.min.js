function PCMPlayer(t){this.init(t)}function iOS(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||navigator.userAgent.includes("Mac")&&"ontouchend"in document}function DVSwitchPlayer(t,e){this.ws=null,this.socketURL="ws://"+document.location.hostname+":"+t,this.sampleRate=iOS()?32e3:8e3,this.player=new PCMPlayer({encoding:"16bitInt",channels:1,sampleRate:this.sampleRate,flushingTime:2e3}),this.btn=e,null!=e&&(this.btnDefault=e.style.color),this.stop()/*,window.addEventListener("unload",function(t){this.destroy()})*/}function playAudioToggle(t,e){void 0===window.dvsp&&(window.dvsp=new DVSwitchPlayer(t,e)),dvsp.isPlaying()?window.dvsp.stop():window.dvsp.play()}PCMPlayer.prototype.init=function(t){this.option=Object.assign({},{encoding:"16bitInt",channels:1,sampleRate:8e3,flushingTime:1e3,lpfilter:!1,lpfreq:16e3},t),this.samples=new Float32Array,this.flush=this.flush.bind(this),this.interval=setInterval(this.flush,this.option.flushingTime),this.maxValue=this.getMaxValue(),this.typedArray=this.getTypedArray(),this.createContext()},PCMPlayer.prototype.getMaxValue=function(){var t={"8bitInt":128,"16bitInt":32768,"32bitInt":2147483648,"32bitFloat":1};return t[this.option.encoding]?t[this.option.encoding]:t["16bitInt"]},PCMPlayer.prototype.getTypedArray=function(){var t={"8bitInt":Int8Array,"16bitInt":Int16Array,"32bitInt":Int32Array,"32bitFloat":Float32Array};return t[this.option.encoding]?t[this.option.encoding]:t["16bitInt"]},PCMPlayer.prototype.createContext=function(){this.audioCtx=new(window.AudioContext||window.webkitAudioContext),this.gainNode=this.audioCtx.createGain(),this.gainNode.gain.value=1,this.filterNode=this.audioCtx.createBiquadFilter(),this.setFilter(this.option.lpfilter,this.option.lpfreq,1),this.filterNode.connect(this.gainNode),this.gainNode.connect(this.audioCtx.destination),this.startTime=this.audioCtx.currentTime},PCMPlayer.prototype.isTypedArray=function(t){return t.byteLength&&t.buffer&&t.buffer.constructor==ArrayBuffer},PCMPlayer.prototype.feed=function(t){if(this.isTypedArray(t)){t=this.getFormatedValue(t);var e=new Float32Array(this.samples.length+t.length);e.set(this.samples,0),e.set(t,this.samples.length),this.samples=e}},PCMPlayer.prototype.getFormatedValue=function(t){var e,t=new this.typedArray(t.buffer),n=new Float32Array(t.length);for(e=0;e<t.length;e++)n[e]=t[e]/this.maxValue;return n},PCMPlayer.prototype.volume=function(t){this.gainNode.gain.value=t},PCMPlayer.prototype.setFilter=function(t,e,n){if(!0==t){this.filterNode.type="lowpass",this.filterNode.frequency.value=e;var o=30;this.filterNode.Q.value=n*o}else{this.filterNode.type="allpass",this.filterNode.frequency.value=e;var o=30;this.filterNode.Q.value=n*o}},PCMPlayer.prototype.stop=function(){this.interval&&clearInterval(this.interval),this.samples=null},PCMPlayer.prototype.play=function(){this.samples=new Float32Array,this.interval&&clearInterval(this.interval),this.interval=setInterval(this.flush,this.option.flushingTime)},PCMPlayer.prototype.destroy=function(){this.stop(),this.audioCtx.close(),this.audioCtx=null},PCMPlayer.prototype.testSampleRate=function(t){success=!1;try{var e=this.audioCtx.createBuffer(1,1,t);e=null,success=!0}catch(n){console.log(`Sample rate ${t} is not supported by the browser: ${n}`)}return success},PCMPlayer.prototype.flush=function(){if(null!=this.samples&&0!=this.samples.length){var t,e,n,o,a,r=this.audioCtx.createBufferSource(),l=this.samples.length/this.option.channels,h=this.audioCtx.createBuffer(this.option.channels,l,this.option.sampleRate);for(e=0;e<this.option.channels;e++)for(o=0,t=h.getChannelData(e),n=e,a=50;o<l;o++)t[o]=this.samples[n],o<50&&(t[o]=t[o]*o/50),o>=l-51&&(t[o]=t[o]*a--/50),n+=this.option.channels;this.startTime<this.audioCtx.currentTime&&(this.startTime=this.audioCtx.currentTime),r.buffer=h,r.connect(this.filterNode),r.start(this.startTime),this.startTime+=h.duration,this.samples=new Float32Array}},PCMPlayer.prototype.beep=function(t,e,n,o,a){var r=this.audioCtx.createOscillator(),l=this.audioCtx.createGain();r.connect(l),l.connect(this.audioCtx.destination),n&&(l.gain.value=n),e&&(r.frequency.value=e),o&&(r.type=o),a&&(r.onended=a),r.start(this.audioCtx.currentTime),r.stop(this.audioCtx.currentTime+(t||500)/1e3)},DVSwitchPlayer.prototype.destroy=function(){this.stop(),this.player.destroy()},DVSwitchPlayer.prototype.play=function(){var t=this;this.setButtonClass("pcm_player_play"),this.ws=new WebSocket(this.socketURL),this.ws.binaryType="arraybuffer",this.ws.closing=!1,this.ws.addEventListener("message",function(e){var n=new Uint8Array(e.data);if(8e3==this.sampleRate)t.player.feed(n);else{var o=t.player.option.sampleRate/8e3,a=new Uint8Array(n.length*o);for(i=0,j=0;i<n.length;i+=2)for(s=0;s<o;s++)a[j++]=n[i],a[j++]=n[i+1];t.player.feed(a)}}),this.player.play(),this.ws.onclose=function(){this.closing||(t.ws=null,t.setButtonClass("pcm_player_error"),setTimeout(function(){t.play(t.btn)},5e3))},this.ws.onopen=function(){}},DVSwitchPlayer.prototype.stop=function(){this.player.stop(),this.isPlaying()&&(this.ws.closing=!0,this.ws.close(),this.ws=null),this.setButtonClass("pcm_player_stop")},DVSwitchPlayer.prototype.isPlaying=function(){return null!=this.ws},DVSwitchPlayer.prototype.setButtonBackground=function(t){null!=this.btn&&(this.btn.style.color=t)},DVSwitchPlayer.prototype.setButtonClass=function(t){null!=this.btn&&(this.btn.className=t)};